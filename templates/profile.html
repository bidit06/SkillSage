<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Career Advisor</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ... (Same styles as before) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Montserrat", sans-serif; background: linear-gradient(135deg, #cc313d 0%, #f7c5cc 100%); min-height: 100vh; padding-bottom: 40px; animation: gradientShift 15s ease infinite; background-size: 200% 200%; }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        /* Header */
        .header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(204, 49, 61, 0.15); position: sticky; top: 0; z-index: 100; animation: slideDown 0.6s ease; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #cc313d 0%, #f7c5cc 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -1px; cursor: pointer; transition: transform 0.3s ease; }
        .logo:hover { transform: scale(1.05); }
        .back-btn { padding: 10px 24px; background: linear-gradient(135deg, #cc313d 0%, #f7c5cc 100%); color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: 700; font-family: "Montserrat", sans-serif; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(204, 49, 61, 0.3); }
        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(204, 49, 61, 0.4); }
        /* Profile Container */
        .profile-container { max-width: 900px; margin: 40px auto; padding: 0 24px; animation: fadeInUp 0.8s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        /* Profile Header */
        .profile-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(204, 49, 61, 0.15); text-align: center; position: relative; overflow: hidden; border: 2px solid rgba(247, 197, 204, 0.3); }
        .profile-header::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient( circle, rgba(247, 197, 204, 0.1) 0%, transparent 70% ); animation: rotate 20s linear infinite; }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .profile-avatar { width: 120px; height: 120px; background: linear-gradient(135deg, #cc313d 0%, #f7c5cc 100%); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px; box-shadow: 0 8px 25px rgba(204, 49, 61, 0.3); animation: float 3s ease-in-out infinite; position: relative; z-index: 1; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .profile-title { font-size: 32px; font-weight: 800; color: #cc313d; margin-bottom: 8px; position: relative; z-index: 1; }
        .profile-subtitle { font-size: 16px; color: #666; font-weight: 500; position: relative; z-index: 1; }
        /* Profile Form */
        .profile-form { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; box-shadow: 0 8px 32px rgba(204, 49, 61, 0.15); border: 2px solid rgba(247, 197, 204, 0.3); position: relative; overflow: hidden; }
        .profile-form::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient( circle, rgba(247, 197, 204, 0.1) 0%, transparent 70% ); animation: rotate 20s linear infinite; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; position: relative; z-index: 1; }
        .form-group { display: flex; flex-direction: column; animation: slideIn 0.6s ease forwards; opacity: 0; }
        .form-group:nth-child(1) { animation-delay: 0.1s; } .form-group:nth-child(2) { animation-delay: 0.2s; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-label { font-size: 14px; font-weight: 700; color: #cc313d; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .form-label span { font-size: 18px; }
        .form-input, .form-select, .form-textarea { padding: 14px 18px; border: 2px solid rgba(247, 197, 204, 0.5); border-radius: 12px; font-size: 15px; font-family: "Montserrat", sans-serif; font-weight: 500; color: #333; background: white; transition: all 0.3s ease; outline: none; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #cc313d; box-shadow: 0 0 0 4px rgba(204, 49, 61, 0.1); transform: translateY(-2px); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23CC313D' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; padding-right: 40px; }
        
        .skills-input-container { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px; border: 2px solid rgba(247, 197, 204, 0.5); border-radius: 12px; min-height: 60px; background: white; transition: all 0.3s ease; }
        .skills-input-container:focus-within { border-color: #cc313d; box-shadow: 0 0 0 4px rgba(204, 49, 61, 0.1); }
        
        /* Tags */
        .skill-tag { background: linear-gradient(135deg, #cc313d 0%, #f7c5cc 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .learning-tag { background: linear-gradient(135deg, #F7C5CC 0%, #CC313D 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .goal-tag { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .qual-tag { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }

        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .remove-skill { cursor: pointer; font-weight: bold; transition: transform 0.2s ease; margin-left: 6px; }
        .remove-skill:hover { transform: scale(1.3); }
        .skills-input-container input { border: none; outline: none; flex: 1; min-width: 120px; font-family: "Montserrat", sans-serif; font-size: 14px; font-weight: 500; }
        
        .button-container { display: flex; gap: 15px; margin-top: 35px; position: relative; z-index: 1; }
        .btn-save, .btn-cancel { flex: 1; padding: 16px 32px; border: none; border-radius: 30px; cursor: pointer; font-size: 16px; font-weight: 700; font-family: "Montserrat", sans-serif; transition: all 0.4s ease; position: relative; overflow: hidden; }
        .btn-save { background: linear-gradient(135deg, #cc313d 0%, #f7c5cc 100%); color: white; box-shadow: 0 6px 20px rgba(204, 49, 61, 0.3); }
        .btn-save::before { content: ""; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .btn-save:hover::before { width: 300px; height: 300px; }
        .btn-save:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(204, 49, 61, 0.4); }
        .btn-cancel { background: white; color: #cc313d; border: 2px solid #cc313d; box-shadow: 0 4px 15px rgba(204, 49, 61, 0.15); }
        .btn-cancel:hover { background: #cc313d; color: white; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(204, 49, 61, 0.3); }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .profile-header { padding: 30px 20px; } .profile-form { padding: 30px 20px; } .button-container { flex-direction: column; } }
        .info-message { background: linear-gradient( 135deg, rgba(204, 49, 61, 0.1) 0%, rgba(247, 197, 204, 0.1) 100% ); border-left: 4px solid #cc313d; padding: 15px 20px; border-radius: 8px; margin-bottom: 25px; font-size: 14px; color: #666; font-weight: 500; position: relative; z-index: 1; animation: slideIn 0.6s ease; }
        .info-message strong { color: #cc313d; font-weight: 700; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="logo" onclick="window.location.href='/dashboard'">Career Advisor</h1>
            <button class="back-btn" onclick="window.location.href='/dashboard'">‚Üê Back to Dashboard</button>
        </div>
    </header>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">üë§</div>
            <h1 class="profile-title">Your Profile</h1>
            <p class="profile-subtitle">Manage your career information and preferences</p>
        </div>

        <div class="profile-form">
            <div class="info-message">
                <strong>üí° Tip:</strong> Complete your profile to get better career recommendations and personalized guidance from Orion!
            </div>

            <form id="profileForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label"><span>üë§</span> Full Name</label>
                        <input type="text" class="form-input" id="name" placeholder="Enter your full name" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span>üìß</span> Email Address</label>
                        <input type="email" class="form-input" id="email" placeholder="your.email@example.com" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span>üìç</span> Location</label>
                        <select class="form-select" id="location" required>
                            <option value="">Select your location</option>
                            <optgroup label="Major Metro Cities">
                                <option value="Mumbai">Mumbai</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Bangalore">Bangalore</option>
                                <option value="Hyderabad">Hyderabad</option>
                                <option value="Chennai">Chennai</option>
                                <option value="Kolkata">Kolkata</option>
                                <option value="Pune">Pune</option>
                            </optgroup>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><span>üíº</span> Employment Status</label>
                        <select class="form-select" id="employmentStatus" required>
                            <option value="">Select status</option>
                            <option value="Employed">Employed</option>
                            <option value="Unemployed">Unemployed</option>
                            <option value="Student">Student</option>
                            <option value="Freelancer">Freelancer</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label"><span>üìö</span> What are you currently doing?</label>
                        <input type="text" class="form-input" id="currentActivity" placeholder="e.g., Pursuing BTech in Data Science" required />
                    </div>
                    
                    <!-- CAREER GOALS (Tag Input) -->
                    <div class="form-group full-width">
                        <label class="form-label"><span>üéØ</span> Career Goals (Press Enter to add)</label>
                        <div class="skills-input-container" id="goalContainer">
                            <input type="text" id="goalInput" placeholder="e.g., Data Scientist, AI Engineer..." />
                        </div>
                    </div>
                    
                    <!-- QUALIFICATIONS (Tag Input) -->
                    <div class="form-group full-width">
                        <label class="form-label"><span>üéì</span> Your Qualifications (Press Enter to add)</label>
                        <div class="skills-input-container" id="qualContainer">
                            <input type="text" id="qualInput" placeholder="e.g., B.Tech CSE, Google Cloud Cert..." />
                        </div>
                    </div>

                    <!-- SKILLS (Tag Input) -->
                    <div class="form-group full-width">
                        <label class="form-label"><span>‚ö°</span> Skills You Know (Press Enter to add)</label>
                        <div class="skills-input-container" id="skillsContainer">
                            <input type="text" id="skillInput" placeholder="Type a skill and press Enter..." />
                        </div>
                    </div>
                    
                    <!-- CURRENTLY LEARNING (Tag Input) -->
                    <div class="form-group full-width">
                        <label class="form-label"><span>üìñ</span> Currently Learning (Press Enter to add)</label>
                        <div class="skills-input-container" id="learningContainer">
                            <input type="text" id="learningInput" placeholder="Type a topic and press Enter..." />
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label"><span>‚ú®</span> Your Dreams & Aspirations</label>
                        <textarea class="form-textarea" id="dreams" placeholder="Share your dreams..."></textarea>
                    </div>
                </div>

                <div class="button-container">
                    <button type="submit" class="btn-save">üíæ Save Profile</button>
                    <button type="button" class="btn-cancel" onclick="window.location.href='/dashboard'">‚úï Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DATA ARRAYS ---
        let skills = [];
        let currentlyLearning = [];
        let careerGoals = [];
        let qualifications = [];

        // --- HELPER: Setup Tag Listener ---
        function setupTagInput(inputId, containerId, dataArray, cssClass, updateFn) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            
            input.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const val = input.value.trim();
                    if (val && !dataArray.includes(val)) {
                        dataArray.push(val);
                        renderTag(val, container, cssClass, (v) => {
                            // Removal callback
                            const index = dataArray.indexOf(v);
                            if (index > -1) dataArray.splice(index, 1);
                        });
                        input.value = "";
                        updateFn(dataArray); // Sync back if needed
                    }
                }
            });
            return { input, container };
        }

        // --- SETUP ALL INPUTS ---
        setupTagInput("skillInput", "skillsContainer", skills, "skill-tag", (arr) => skills = arr);
        setupTagInput("learningInput", "learningContainer", currentlyLearning, "learning-tag", (arr) => currentlyLearning = arr);
        setupTagInput("goalInput", "goalContainer", careerGoals, "goal-tag", (arr) => careerGoals = arr);
        setupTagInput("qualInput", "qualContainer", qualifications, "qual-tag", (arr) => qualifications = arr);

        // --- GENERIC RENDER FUNCTION ---
        function renderTag(text, container, cssClass, removeCallback) {
            const tag = document.createElement("div");
            tag.className = cssClass;
            
            const textNode = document.createTextNode(text);
            tag.appendChild(textNode);
            
            const closeBtn = document.createElement("span");
            closeBtn.className = "remove-skill";
            closeBtn.innerHTML = "√ó";
            closeBtn.onclick = function() {
                removeCallback(text);
                tag.remove();
            };
            
            tag.appendChild(closeBtn);
            
            // Insert before the input field
            const inputField = container.querySelector("input");
            container.insertBefore(tag, inputField);
        }

        // --- LOAD DATA FROM MONGODB ---
        window.addEventListener("load", async function () {
            try {
                const response = await fetch("/api/profile");
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("name").value = data.name || "";
                    document.getElementById("email").value = data.email || "";
                    document.getElementById("email").setAttribute("readonly", true);
                    document.getElementById("email").style.opacity = "0.7";
                    document.getElementById("location").value = data.location || "";
                    document.getElementById("employmentStatus").value = data.employment_status || "";
                    document.getElementById("currentActivity").value = data.current_activity || "";
                    document.getElementById("dreams").value = data.dreams || "";

                    // Helper to load tags
                    const loadTags = (source, targetArray, container, cssClass) => {
                        if (source && Array.isArray(source)) {
                            source.forEach(item => {
                                if (!targetArray.includes(item)) {
                                    targetArray.push(item);
                                    renderTag(item, container, cssClass, (v) => {
                                        const idx = targetArray.indexOf(v);
                                        if (idx > -1) targetArray.splice(idx, 1);
                                    });
                                }
                            });
                        }
                    };

                    loadTags(data.skills, skills, document.getElementById("skillsContainer"), "skill-tag");
                    loadTags(data.currently_learning, currentlyLearning, document.getElementById("learningContainer"), "learning-tag");
                    loadTags(data.career_goal, careerGoals, document.getElementById("goalContainer"), "goal-tag");
                    loadTags(data.qualifications, qualifications, document.getElementById("qualContainer"), "qual-tag");

                } else if (response.status === 401) {
                    window.location.href = "/auth";
                }
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        });

        // --- SAVE DATA ---
        document.getElementById("profileForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const saveBtn = document.querySelector(".btn-save");
            const originalText = saveBtn.innerText;
            saveBtn.innerText = "Saving...";

            const profileData = {
                name: document.getElementById("name").value,
                location: document.getElementById("location").value,
                employment_status: document.getElementById("employmentStatus").value,
                current_activity: document.getElementById("currentActivity").value,
                
                // SEND ALL ARRAYS
                career_goal: careerGoals,
                qualifications: qualifications,
                skills: skills,
                currently_learning: currentlyLearning,
                
                dreams: document.getElementById("dreams").value,
            };

            try {
                const response = await fetch("/api/profile", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(profileData),
                });

                if (response.ok) {
                    saveBtn.innerHTML = "‚úì Saved Successfully!";
                    saveBtn.style.background = "linear-gradient(135deg, #2ecc71, #27ae60)";
                    setTimeout(() => {
                        window.location.href = "/dashboard";
                    }, 1000);
                } else {
                    alert("Failed to save profile. Please try again.");
                    saveBtn.innerText = originalText;
                }
            } catch (error) {
                console.error("Error saving profile:", error);
                saveBtn.innerText = originalText;
            }
        });
    </script>
</body>
</html>