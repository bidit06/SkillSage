<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Clone</title>
    
    <script>
        // Check for saved theme preference or system default
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }
        
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = "/";
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS STYLES --- */
        :root {
            /* DEFAULT: Premium Light Theme */
            --bg-color: #FFFDF6;
            --sidebar-bg: #E2D4E0;
            --text-color: #4C5372;
            --secondary-text: #7C7E9D;
            --hover-bg: #dcd0da;
            --input-bg: #ffffff;
            --accent-color: #4C5372;
            --user-msg-bg: #E2D4E0;
            --border-color: #949AB1;
            --icon-color: #4C5372;
        }

        /* DARK MODE OVERRIDES */
        body.dark-mode {
            --bg-color: #131314;
            --sidebar-bg: #1e1f20;
            --text-color: #e3e3e3;
            --secondary-text: #c4c7c5;
            --hover-bg: #282a2c;
            --input-bg: #1e1f20;
            --accent-color: #a8c7fa;
            --user-msg-bg: #282a2c;
            --border-color: #444746;
            --icon-color: #e3e3e3;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; transition: background 0.3s, color 0.3s, border-color 0.3s; }
        body { background-color: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        #sidebar { width: 280px; background-color: var(--sidebar-bg); display: flex; flex-direction: column; padding: 20px 15px; flex-shrink: 0; border-right: 1px solid var(--border-color); }
        
        .new-chat-btn { 
            background-color: var(--hover-bg); 
            color: var(--text-color); 
            border: 1px solid var(--border-color); 
            padding: 12px 15px; 
            border-radius: 50px; 
            cursor: pointer; 
            display: flex; align-items: center; gap: 10px; 
            font-size: 14px; font-weight: 600; 
            margin-bottom: 25px; 
            transition: all 0.2s; 
        }
        .new-chat-btn:hover { background-color: var(--input-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .chat-list-label { font-size: 12px; color: var(--secondary-text); padding: 0 10px; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        #chat-history { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        
        .chat-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-radius: 8px; cursor: pointer; color: var(--text-color); font-size: 14px; position: relative; text-decoration: none; }
        .chat-item:hover, .chat-item.active { background-color: var(--hover-bg); }
        .chat-item.active { font-weight: 600; background-color: var(--input-bg); }
        .chat-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; pointer-events: none; }
        
        .chat-options-btn { background: none; border: none; color: var(--secondary-text); cursor: pointer; padding: 4px; border-radius: 50%; display: none; align-items: center; justify-content: center; }
        .chat-item:hover .chat-options-btn { display: flex; }
        .chat-options-btn:hover { background-color: var(--border-color); color: var(--text-color); }

        /* Dropdown */
        .dropdown-menu { position: absolute; right: 10px; top: 35px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100; display: none; flex-direction: column; min-width: 120px; overflow: hidden; }
        .dropdown-menu.show { display: flex; }
        .dropdown-item { padding: 10px 15px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; color: var(--text-color); }
        .dropdown-item:hover { background-color: var(--hover-bg); }
        .dropdown-item.delete { color: #ff6b6b; }

        /* Main Content */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--bg-color); position: relative; }
        
        header { 
            padding: 20px 30px; 
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--text-color); 
            border-bottom: 1px solid var(--border-color); 
            background: var(--bg-color); 
        }
        
        .header-actions { display: flex; align-items: center; gap: 15px; }

        /* Dark Mode Button */
        .theme-toggle-btn { 
            background: var(--hover-bg); 
            border: 1px solid var(--border-color); 
            color: var(--icon-color); 
            cursor: pointer; 
            width: 40px; height: 40px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .theme-toggle-btn:hover { background-color: var(--border-color); transform: scale(1.05); }
        
        .back-dashboard-btn { display: flex; align-items: center; gap: 8px; padding: 10px 20px; background-color: var(--sidebar-bg); color: var(--text-color); text-decoration: none; border-radius: 20px; font-size: 14px; font-weight: 600; transition: background 0.2s; margin-left: 15px; border: 1px solid var(--border-color); }
        .back-dashboard-btn:hover { background-color: var(--input-bg); }

        #chat-container { flex-grow: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .welcome-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; animation: fadeIn 0.8s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .welcome-text { font-size: 42px; color: var(--text-color); font-weight: 700; margin-bottom: 15px; }
        .welcome-subtext { color: var(--secondary-text); font-size: 18px; }
        
        .message-wrapper { width: 100%; max-width: 800px; display: flex; gap: 20px; }
        .message-wrapper.user { justify-content: flex-end; }
        .message-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .ai-icon { background: var(--accent-color); }
        .user-icon { background-color: var(--secondary-text); }
        
        .message-content { line-height: 1.6; font-size: 16px; color: var(--text-color); display: flex; flex-direction: column; gap: 8px; max-width: 80%; }
        .user .message-content { background-color: var(--user-msg-bg); padding: 15px 20px; border-radius: 20px 20px 5px 20px; border: 1px solid var(--border-color); }
        
        /* Attachments */
        .attachment-preview { display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 10px 15px; border-radius: 8px; font-size: 13px; border: 1px solid var(--border-color); }
        .attachment-preview img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        
        #input-container { padding: 30px; display: flex; justify-content: center; background-color: var(--bg-color); }
        #input-wrapper { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 10px; }
        #file-preview-area { display: none; flex-wrap: wrap; gap: 10px; padding: 0 10px; }
        .preview-chip { background-color: var(--input-bg); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); }
        
        .input-box { width: 100%; background-color: var(--input-bg); border-radius: 50px; padding: 12px 25px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: box-shadow 0.3s; }
        .input-box:focus-within { box-shadow: 0 6px 20px rgba(76, 83, 114, 0.15); border-color: var(--text-color); }
        #message-input { flex-grow: 1; background: transparent; border: none; color: var(--text-color); font-size: 16px; outline: none; padding: 5px 0; }
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--secondary-text); padding: 8px; border-radius: 50%; display: flex; transition: color 0.2s; }
        .icon-btn:hover { color: var(--text-color); background-color: var(--hover-bg); }

        /* Rename Modal */
        #rename-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-content { background: var(--bg-color); padding: 30px; border-radius: 16px; width: 350px; display: flex; flex-direction: column; gap: 20px; color: var(--text-color); border: 1px solid var(--border-color); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .modal-input { padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 8px; outline: none; font-size: 15px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }
        .btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; border: none; font-size: 14px; font-weight: 600; }
        .btn-cancel { background: transparent; color: var(--secondary-text); border: 1px solid var(--border-color); }
        .btn-confirm { background: var(--text-color); color: var(--bg-color); }
    </style>
</head>

<body class="">

    <aside id="sidebar">
        <button class="new-chat-btn" onclick="startNewChat()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5V19M5 12H19"/></svg>
            New Chat
        </button>
        <div class="chat-list-label">Recent</div>
        <div id="chat-history"></div>
    </aside>

    <main id="main-content">
        <header>
            <div style="display:flex; align-items:center;">
                <div style="font-weight: 700; font-size: 20px; color: var(--text-color);">Gemini Clone</div>
                <a href="/dashboard" class="back-dashboard-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    Back to Dashboard
                </a>
            </div>

            <div class="header-actions">
                <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
                    <svg id="theme-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>

                <div class="user-icon" onclick="window.location.href='/profile'" style="width: 36px; height: 36px; border-radius: 50%; overflow: hidden; cursor: pointer;" title="Go to Profile">
                    <svg viewBox="0 0 24 24" fill="var(--secondary-text)" width="36" height="36"><circle cx="12" cy="12" r="12"/></svg>
                </div>
            </div>
        </header>

        <div id="chat-container">
            <div id="welcome-message" class="welcome-screen">
                <div class="welcome-text">Hello, User</div>
                <div class="welcome-subtext">How can I help you today?</div>
            </div>
            <div id="messages-list" style="width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px;"></div>
        </div>

        <div id="input-container">
            <div id="input-wrapper">
                <div id="file-preview-area"></div>
                <div class="input-box">
                    <button class="icon-btn" onclick="document.getElementById('file-upload').click()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    </button>
                    <input type="file" id="file-upload" style="display: none;" onchange="handleFileUpload(event)">
                    <input type="text" id="message-input" placeholder="Enter a prompt here" autocomplete="off">
                    <button id="send-btn" class="icon-btn" onclick="handleSendMessage()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="rename-modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 0;">Rename Chat</h3>
            <input type="text" id="rename-input" class="modal-input" placeholder="New Chat Name">
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeRenameModal()">Cancel</button>
                <button class="btn btn-confirm" onclick="confirmRename()">Rename</button>
            </div>
        </div>
    </div>

    <script>
        // --- THEME TOGGLE LOGIC ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            if (isDark) {
                // Sun Icon
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            } else {
                // Moon Icon
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            }
        }

        // Initialize Theme Icon on Load
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem('theme') === 'dark';
            if(isDark) document.body.classList.add('dark-mode');
            updateThemeIcon(isDark);
        });

        // ... (Rest of JS Logic remains exactly the same) ...
        let chats = []; 
        let currentChatId = null; 
        let currentFile = null;
        let chatToRenameId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadSidebar(); 
            const inputField = document.getElementById('message-input');
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    handleSendMessage();
                }
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-item')) {
                    closeAllDropdowns();
                }
            });
        });

        async function loadSidebar() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('/api/chats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    chats = await response.json(); 
                    renderSidebar(); 
                }
            } catch (error) {
                console.error("Failed to load sidebar:", error);
            }
        }

        function renderSidebar() {
            const container = document.getElementById('chat-history');
            container.innerHTML = '';

            chats.forEach(chat => {
                const isActive = chat.id === currentChatId ? 'active' : '';
                const div = document.createElement('div');
                div.className = `chat-item ${isActive}`;
                
                div.onclick = (e) => {
                    if (!e.target.closest('.chat-options-btn') && !e.target.closest('.dropdown-menu')) {
                        loadChat(chat.id);
                    }
                };
                
                div.innerHTML = `
                    <div style="display:flex; align-items:center; overflow:hidden;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 10px; flex-shrink:0;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <span class="chat-title">${chat.title}</span>
                    </div>
                    <button class="chat-options-btn" onclick="toggleMenu('${chat.id}', event)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="2"/><circle cx="12" cy="5" r="2"/><circle cx="12" cy="19" r="2"/></svg>
                    </button>
                    <div class="dropdown-menu" id="menu-${chat.id}">
                        <div class="dropdown-item" onclick="openRenameModal('${chat.id}')">Rename</div>
                        <div class="dropdown-item delete" onclick="deleteChat('${chat.id}')">Delete</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleMenu(chatId, event) {
            event.stopPropagation(); 
            closeAllDropdowns();
            const menu = document.getElementById(`menu-${chatId}`);
            menu.style.display = 'flex';
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
        }

        async function deleteChat(id) {
            if(!confirm("Are you sure you want to delete this chat?")) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/chats/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if(response.ok) {
                    chats = chats.filter(c => c.id !== id);
                    if(currentChatId === id) startNewChat();
                    renderSidebar();
                } else {
                    console.error("Delete failed");
                }
            } catch(e) { console.error(e); }
        }

        function openRenameModal(id) {
            chatToRenameId = id;
            const chat = chats.find(c => c.id === id);
            document.getElementById('rename-input').value = chat.title;
            document.getElementById('rename-modal').style.display = 'flex';
            document.getElementById('rename-input').focus();
            closeAllDropdowns();
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').style.display = 'none';
            chatToRenameId = null;
        }

        async function confirmRename() {
            if (!chatToRenameId) return;
            const newName = document.getElementById('rename-input').value.trim();
            if (newName) {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch(`/api/chats/${chatToRenameId}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` 
                        },
                        body: JSON.stringify({ title: newName })
                    });

                    if(response.ok) {
                        const chat = chats.find(c => c.id === chatToRenameId);
                        chat.title = newName;
                        renderSidebar();
                    }
                } catch(e) { console.error(e); }
            }
            closeRenameModal();
        }

        function startNewChat() {
            currentChatId = null; 
            document.getElementById('messages-list').innerHTML = ''; 
            document.getElementById('welcome-message').style.display = 'flex'; 
            renderSidebar();
        }

        async function loadChat(id) {
            currentChatId = id;
            document.getElementById('messages-list').innerHTML = '';
            document.getElementById('welcome-message').style.display = 'none';
            renderSidebar(); 

            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/chats/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const chatData = await response.json();
                    if (chatData.messages) {
                        chatData.messages.forEach(msg => renderMessage(msg));
                    }
                }
            } catch (e) {
                console.error("Error loading chat", e);
            }
        }

        async function handleSendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text && !currentFile) return;

            const newMessage = { text: text, sender: 'user', attachment: currentFile };
            renderMessage(newMessage);

            document.getElementById('welcome-message').style.display = 'none';

            const fileToSend = currentFile ? currentFile.fileObject : null;
            input.value = ''; 
            clearFile();      

            const formData = new FormData();
            formData.append("user_message", text);
            formData.append("chat_id", currentChatId || ""); 
            if (fileToSend) formData.append("user_upload", fileToSend);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (!currentChatId || currentChatId !== data.chat_id) {
                        currentChatId = data.chat_id;
                        loadSidebar(); 
                    }
                    const aiMsg = { text: data.ai_response, sender: 'ai' };
                    if (currentChatId === data.chat_id) {
                        renderMessage(aiMsg);
                    }
                } else {
                    console.error("Server Error");
                }
            } catch (error) {
                console.error("Network Error", error);
            }
        }

        function renderMessage(msg) {
            const container = document.getElementById('messages-list');
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${msg.sender}`;

            const icon = document.createElement('div');
            icon.className = `message-icon ${msg.sender === 'user' ? 'user-icon' : 'ai-icon'}`;
            icon.innerHTML = msg.sender === 'ai' 
                ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 16l-2.5-1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>`
                : `<svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;

            const content = document.createElement('div');
            content.className = 'message-content';

            if (msg.attachment || msg.file_name) {
                const attachDiv = document.createElement('div');
                attachDiv.className = 'attachment-preview';
                let iconHtml = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path></svg>`;
                if (msg.attachment && msg.attachment.url) {
                    if (msg.attachment.type.startsWith('image/')) iconHtml = `<img src="${msg.attachment.url}">`;
                }
                attachDiv.innerHTML = `${iconHtml}<span>${msg.attachment ? msg.attachment.name : (msg.file_name || 'File')}</span>`;
                content.appendChild(attachDiv);
            }

            if (msg.text) {
                const textDiv = document.createElement('div');
                textDiv.innerText = msg.text;
                content.appendChild(textDiv);
            }

            if (msg.sender === 'ai') {
                wrapper.appendChild(icon);
                wrapper.appendChild(content);
            } else {
                wrapper.appendChild(content);
                wrapper.appendChild(icon);
            }

            container.appendChild(wrapper);
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            currentFile = {
                fileObject: file, 
                name: file.name,
                type: file.type,
                url: URL.createObjectURL(file)
            };
            const area = document.getElementById('file-preview-area');
            area.style.display = 'flex';
            area.innerHTML = `<div class="preview-chip"><span>${file.name}</span><span style="cursor:pointer;margin-left:5px;" onclick="clearFile()">Ã—</span></div>`;
        }

        function clearFile() {
            currentFile = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview-area').style.display = 'none';
        }
    </script>
</body>
</html>